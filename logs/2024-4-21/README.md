# 关于项目首次上线遇到的一些问题

---

### 由于没有做好异常捕获从而导致很多任务提前终止

因为项目首次上线的时候还没有引入`异步Celery任务队列`，因此使用的课程选择器是基于`requests`包实现的，也就是`同步课程选择器`。

_`异步Celery任务队列`指的是使用`asyncio`包来实现并发的`Celery`；而官方提供的`Celery`是不支持`asyncio`来实现任务并发的。_

由于从发送请求到接收响应的过程是非常漫长的，一般大概在20分钟左右（我会尽量合理的设置请求超时的时间）。因此我可以预知到肯定会出现接收响应超时的情况，而对于`requests`来说，接收响应超时会抛出一个`requests.exceptions.ReadTimeout`异常，所以我明确的对所有发送请求的地方加上了对该异常的捕获，并且在生产环境中也正如我所料引发了对应的异常。__但是，在生产环境时还同时引发了多个我并未预知到的异常。__

下面我就列举出两个非常致命的异常：

* `requests.exceptions.ConnectTimeout`

  描述：该异常发生在与服务器建立连接的时候超时。

  原因：服务器接收的请求数量太多，后面的请求将排队等待连接，而这个等待连接的时间超出了提前设置好的请求超时时间。

  解决办法：最大可能的延长请求超时时间。

* `requests.exceptions.ConnectionError`

  描述：该异常发生在与服务器建立连接时，服务器拒绝了客户端的请求。

  原因：服务器接收的请求数量过多，导致服务器直接拒绝了部分客户端的请求。

  解决方法：既然这台服务器已经达到了可接收的最大请求数，那就可以考虑对另一台服务器发送请求。

为什么说这两个异常是最致命的呢？因为任意一个异常被引发，那么这个课程选择器将提前终止程序。再加上由于我的盲目自信，没有为Celery添加异常重试策略，所以结果可想而知……

### 复盘和总结

* _不要盲目自信，要为每一件事情和每一个情况提前做好最坏的打算。_
* _没有经过生产环境考验的项目是没有任何实际意义的。_

在项目处在开发和测试环境时，没有测试出任何的bug，这就带给我一种盲目乐观的心态，从而导致了悲观的发生……

也算是这次生产环境带给我的一个惨痛的教训，同时也由于自己的这些疏忽，没有帮助到更多的人完成选课，心里确实挺内疚的。